@model IEnumerable<Data_Access_Layer.Models.MessageChat>

    <style>

    .arrow {
        cursor: pointer;
        height: 60px; /* Adjusted height */
        left: 50%;
        position: absolute;
        top: 50%;
        transform: translateX(-50%) translateY(-50%);
        transition: transform .1s;
        width: 40px; /* Adjusted width */
    }

    .arrow-top,
    .arrow-bottom {
        background-color: #666;
        height: 2px; /* Adjusted height */
        left: -5px;
        position: absolute;
        top: 50%;
        width: 100%;
    }

        .arrow-top:after,
        .arrow-bottom:after {
            background-color: #fff;
            content: '';
            height: 100%;
            position: absolute;
            top: 0;
            transition: all 0.15s;
        }

    .arrow-top {
        transform: rotate(30deg); /* Adjusted rotation */
        transform-origin: bottom right;
    }

        .arrow-top:after {
            left: 100%;
            right: 0;
            transition-delay: 0s;
        }

    .arrow-bottom {
        transform: rotate(-30deg); /* Adjusted rotation */
        transform-origin: top right;
    }

        .arrow-bottom:after {
            left: 0;
            right: 100%;
            transition-delay: 0.15s;
        }

    .arrow:hover .arrow-top:after {
        left: 0;
        transition-delay: 0.15s;
    }

    .arrow:hover .arrow-bottom:after {
        right: 0;
        transition-delay: 0s;
    }

    .arrow:active {
        transform: translateX(-50%) translateY(-50%) scale(0.9);
    }
</style>

<div style="margin-left: 12%;">

   


<a class="collapse-item btn btn-primary" asp-controller="MessageChatingV1" asp-action="MessageChatView">Go To Back</a>
</div>
<div class="card" style="width:750px; margin:auto">
    <div class="whatsapp_main">
        <div class="row">
            <div></div>
            <div class="col-lg-12">
                <div class="whatsapp_main_sidemenu" style="background: rgb(2,0,36);
                    background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(0,0,200,1) 0%, rgba(15,142,224,1) 35%, rgba(0,0,162,1) 100%, rgba(0,212,255,1) 100%);">
                    <div class="whatapp_main_sidemenu_top" style="padding: 5px;">
                        <div class="row">
                           
                            <div class="avatar col-lg-1 col-md-2 col-sm-2">



                                <a asp-controller="MessageChatingV1" asp-action="MessageChatView">
                                  
                                    <img src="~/Images/BackImageButton.png" style="width: 50px; height: 50px;">
                                </a>
                              
                            </div>
                            <div class=" col-lg-1 col-md-2 col-sm-2">



                                

                            </div>
                            <div class="avatar col-lg-1 col-md-2 col-sm-2">

                              


                                <img style="border-radius: 50%; height: 62px; width: 62px"
                                    src="https://images.pexels.com/photos/1987301/pexels-photo-1987301.jpeg?auto=compress&cs=tinysrgb&w=600"
                                    alt="">
                            </div>
                            <p class="text-center" style="color: white; font-size: 30px; padding-left: 15px;">@ViewBag.UserName
                            </p>
                            <div class="col-lg-4 col-md-7 col-sm-10">
                                <div class="row text-center my-3">
                                    
                                    @*<div class="col-2" style="font-size: 30px;">
                                        <i style="color: white" class="fa fa-sync-alt"></i>
                                    </div>
                                    <div class="col-1" style="font-size: 30px;">
                                       @* <i style="color: white" class="fa fa-envelope"></i>
                                    </div>*@
                                   
                                </div>
                            </div>
                            <div class="col-lg-1 col-md-1 col-sm-10">

                                <div class="col-1" style="font-size: 30px; margin-left:15px;">
                                    <i style="color: white" class="fas fa-ellipsis-v"></i>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <!----UserList Show----->
            <div class="col-lg-12">
                <div class="whatapp_main_sidemenu_bottom" style="background-image: url('/Images/whatupImage.jpg')">
                    <div class="whatapp_main_sidemenu_bottom_chat">
                        <div class="scrollable-div" style=" overflow-y:auto;">
                            <meta http-equiv="refresh" content="@ViewBag.RefreshInterval / 1000" />
                             <ul id="messageList" class="messages">
                                   @foreach (var message in ViewBag.Message)
                                  {
                                       <li class="you">
                                                @if (message.SenderId == ViewBag.CurrentLoginUseid)
                                                {
                                            <div style="list-style-type: none; margin-bottom: 10px; margin-left: 300px; text-align: right;">
                                                <p style="background-color: deeppink; color: white; font-size: 30px; display: inline-block; padding: 10px; max-width: 70%; border-radius: 28px; word-wrap: break-word;">
                                                    @message.Text
                                                </p>
                                                <p style="color: white; font-size: 20px; text-align: right; margin-top: 5px;">
                                                    @message.SentAt.ToString("HH:mm")
                                                </p>
                                            </div>

                                                  
                                                    }
                                            

                                                else
                                                {
                                                  <div style="list-style-type: none;margin-bottom: 10px;">

                                                     <p style="text-align: left; background-color: green ; color: white;font-size:30px;  display: inline-block;padding: 10px; max-width: 70%; border-radius: 28px; word-wrap: break-word; ">
                                                      @message.Text
                                                     </p>
                                                      <p style="color:white; font-size:20px;text-align: left">@message.SentAt.ToString("HH:mm")  </p>
                                                   </div>
                                                 }
                                              
                                       </li>
                                   }
                              </ul>
                        </div>
                        <form id="sendMessageForm" style="background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(0,0,200,1) 0%, rgba(15,142,224,1) 35%, rgba(0,0,162,1) 100%, rgba(0,212,255,1) 100%);"
                              method="post">
                            <input type="hidden" id="receiverId" name="receiverId" value="@ViewBag.RecieverId" />
                            <input type="text" id="messageContent" name="messageContent" class="SearchBar"
                                   placeholder="Type Your Message...." style="height:50px;margin-left:20px;margin-right:10px;" />
                            <button type="submit" class="beautiful-button">SEND</button>
                       </form>
 </div>
 </div>

      
 <style>
                            /* Add this to your existing CSS or style tag */
                            .scrollable-div {
                                max-height: 700px; /* Set your desired max height */
                                overflow-y: auto;
                                overflow: auto;
                                flex-direction: column-reverse;
                            }
                        </style>

                        <link href="~/css/messagechatui.css" rel="stylesheet" />

                        @section Scripts
                            {
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.9/signalr.min.js"></script>



                   
                            <script>
                                $(document).ready(function () {
                            const container = document.getElementById("messageList");
                            container.scrollTop = container.scrollHeight;
                                    const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

                                    connection.on("ReceiveMessage", function (senderId, messageContent) {
                                        const messageList = $("#messageList");

                                        const messageElement = `<li>
                                                            <div>
                                                                ${senderId === "@ViewBag.SenderUserId" ?
                                                `<p style="text-align: right; background-color: #e1f0ff;">${messageContent}</p>` :
                                                (senderId === "@ViewBag.RecieverId" ?
                                                    `<p style="text-align: left; background-color: black; color: white;">${messageContent}</p>` :
                                                    '')
                                            }
                                                            </div>
                                                        </li>`;

                                        messageList.append(messageElement);
                                        location.reload();
                                const container = document.getElementById("messageList");
                                container.scrollTop = container.scrollHeight;
                                    });

                                    connection.start().then(function () {
                                        connection.invoke("GetUserId").catch(function (err) {
                                            return console.error(err.toString());
                                        });
                                    }).catch(function (err) {
                                        return console.error(err.toString());
                                    });

                                    $("#sendMessageForm").submit(function (event) {
                                        event.preventDefault(); // Prevent default form submission

                                        const messageContent = $("#messageContent").val();
                                        const receiverId = $("#receiverId").val();
                                        console.log(messageContent + "gg" + receiverId);

                                        // Save the message to the database using AJAX
                                        SaveMessage(messageContent, receiverId);
                                    });

                                    function SaveMessage(messageContent, receiverId) {
                                        $.ajax({
                                            url: "/MessageChatingV1/SendMessage", // Replace with your controller and action
                                            method: "POST",
                                            data: {
                                                receiverId: receiverId,
                                                messageContent: messageContent
                                            },
                                            success: function (response) {
                                                console.log("Message saved successfully:", response);
                                       
                                                // Notify the server to broadcast the message
                                                connection.invoke("SendMessage", receiverId, messageContent).catch(function (err) {
                                                    return console.error(err.toString());
                                                });

                                                // Clear the input field if needed
                                                $("#messageContent").val("");
                                            },
                                            error: function (error) {
                                                console.error("Error saving message:", error);
                                            }
                                        });
                                    }
                                });
                            </script>
                        }
